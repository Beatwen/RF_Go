@page "/mapping-dialog"
@using RF_Go.Models
@using RF_Go.Services
@using RF_Go.Services.Mapping
@using RF_Go.Services.NetworkProtocols
@using MudBlazor
@inject IDialogService DialogService
@inject DeviceMappingService DeviceMappingService

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">Choose a device to map</MudText>
        <MudTable Items="@MatchingOfflineDevices">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Brand</MudTh>
                <MudTh>Model</MudTh>
                <MudTh>Frequency</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Name</MudTd>
                <MudTd>@context.Brand</MudTd>
                <MudTd>@context.Model</MudTd>
                <MudTd>@context.Frequency</MudTd>
                <MudTd>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="() => SyncToDevice(context)">
                        Sync to Device
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" @onclick="() => SyncFromDevice(context)">
                        Sync from Device
                    </MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Secondary">Cancel</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public List<RFDevice> MatchingOfflineDevices { get; set; }
    [Parameter] public DeviceDiscoveredEventArgs OnlineDevice { get; set; }

    private async Task SyncToDevice(RFDevice offlineDevice)
    {
        if (offlineDevice == null || OnlineDevice == null)
        {
            throw new ArgumentNullException("Device cannot be null");
        }

        await DeviceMappingService.SyncToDevice(offlineDevice, OnlineDevice);
        MudDialog.Close(DialogResult.Ok(offlineDevice));
    }

    private void SyncFromDevice(RFDevice offlineDevice)
    {
        if (offlineDevice == null || OnlineDevice == null)
        {
            throw new ArgumentNullException("Device cannot be null");
        }

        DeviceMappingService.SyncFromDevice(offlineDevice, OnlineDevice);
        MudDialog.Close(DialogResult.Ok(offlineDevice));
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
